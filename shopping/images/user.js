define(["require","exports","module","cookie","ajax"],function(e,t,n){function u(e){var t,n;t=String.fromCharCode(2),e=decodeURIComponent(e),n=e.split(t),n.length>=7?l.set({userId:n[0]*1,userName:n[1],vipLevel:n[5],rewardImg:n[6]}):l.set({userId:n[0]*1,userName:n[1]})}function a(e){o.getJSON(Y.domains.loginSite+"/login-info","",function(t){l.set(t),e&&e()})}function f(e,t){$.ajax({url:r,type:"get",dataType:"jsonp",jsonp:"callback",success:function(n){if(n&&!n.error)if(n.realVip&&parseInt(n.realVip)>0||n.isWo){l.set("vipInfo",n),e(n);return}t()},error:function(){t()}})}var r="//vip.yinyuetai.com/vip/check-vip",i,s,o;i=e("cookie"),o=e("ajax"),e(["modules/yinyuetai/login-register/main"]),s=Backbone.Model.extend({defaults:{userName:"",userId:0,vipLevel:0,rewardImg:""},isLogined:function(){return parseInt(this.get("userId"))?!0:!1},onLogin:function(e){this.on("logined",e)},logined:function(e){this.isLogined()?e():this.on("logined",e)},register:function(t,n){var r=this;this.isLogined()?t():(this.on("login",t),e(["modules/yinyuetai/login-register/login-register-box"],function(e){e.show("register"),e.observer.one("manualCloseLoginRegisterDialog",function(){r.off("login"),n&&n()})}))},login:function(t,n){var r=this;this.isLogined()?t():(this.on("login",t),e(["modules/yinyuetai/login-register/login-register-box"],function(e){e.show("login"),e.observer.one("manualCloseLoginRegisterDialog",function(){r.off("login"),n&&n()})}))},emit:function(){function r(){var e=document.cookie.match(/[^ =;]+(?=\=)/g);if(e)for(var t=e.length;t--;)document.cookie=e[t]+"=0;expires="+(new Date(0)).toUTCString()}var e,t,n;e=i.get("token"),t=i.get("u_inf"),n=i.get("withmobile"),typeof n!="undefined"?this.setWithmobile(n):e!=null&&(t!=null&&t.length>0?u(t,n):a())},setWithmobile:function(e){this.set({withmobile:e}),o.getJSON("//login.yinyuetai.com/logout")},unsetWithmobile:function(){this.unset("withmobile")},getUserInfo:function(e,t){if(this.isLogined()){var n=this;typeof e=="function"&&(t=e);var r=function(){return typeof e=="function"?n.toJSON():n.get(e)};n.has("isEmailVerified")?t&&t(r()):a(function(){t&&t(r())})}},checkEmail:function(t){this.getUserInfo("isEmailVerified",function(n){if(!n){var r='<div style="padding: 20px 30px;"><p>您好像还没有进行邮箱验证。</p><p>为不影响部分功能的使用，请先进行 <a href="'+Y.domains.homeSite+'/settings/bind" target="_blank" class="special f14">邮箱验证</a></p>'+"</div>";e(["dialog"],function(e){new e(r,{title:"邮箱验证",width:400,height:100,isAutoShow:!0})})}else t&&t()})},checkVIP:function(e,t){if(!this.isLogined())this.login(function(){f(e,t)},t);else if(l.get("vipInfo")){var n=l.get("vipInfo");n&&!n.error&&n.realVip&&parseInt(n.realVip)>0?e(n):t()}else f(e,t)},isVipUser:function(){var e=i.get("token");if(e){var t=e.split("."),n;if(t.length>2)return n=t[2],parseInt(n[0])>0}return!1},getToken:function(){return i.get("token")}});var l=new s;return l.on("change:userId",function(){l.trigger("logined"),l.trigger("login")}),l.emit(),l});