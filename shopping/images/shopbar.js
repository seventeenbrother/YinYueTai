define(["require","exports","module","user","alertify","app/shop/tpl/list","juicer"],function(e,t,n){function u(){var e=location.search,t={};if(e.indexOf("?")!=-1){var n=e.substr(1),r=n.split("&");for(var i=0;i<r.length;i++)t[r[i].split("=")[0]]=decodeURIComponent(r[i].split("=")[1])}return t}function g(e,t,n){var r,i,s,o,u,a;r=0,i="",s=/[^\x00-\xff]/g,o="",u=e.replace(s,"**").length;for(a=0;a<u;a++){o=e.charAt(a).toString(),o.match(s)!=null?r+=2:r++;if(r>t)break;i+=o}return n&&u>t&&(i+="..."),i}function y(){v.init()}var r=e("user"),i=e("alertify"),s=e("app/shop/tpl/list"),o=e("juicer"),a=u().keyword;a&&$(".shop_search input").val(a);var f=Y.domains.shopSite+"/search/suggest.json",l=Y.domains.shopSite+"/search/keyword/record.json",c=Y.domains.shopSite+"/search/artist.json",h=Y.domains.shopSite+"/search/keyword/relatedHot.json?hotsize=8",p=Y.domains.shopSite+"/search/keyword/remove.json",a,d=$(".shop_recommend"),v={init:function(){var t=this;e(["modules/yinyuetai/login-register/main"]),r.isLogined()||this._notLoginHandler(),r.logined(function(){$(window).off("focus"),$(".J_shop_login").hide(),t._loginHandler()}),t.events()},events:function(){var e=this;$("body").on("click",".J_shop_login",function(e){/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase())&&(window.location.href="http://m.yinyuetai.com/login?redirect=https://shop.yinyuetai.com/815")}),$(".myorder").on("click",function(){r.login(function(){location.href="https://trade.yinyuetai.com/order-list"})}),$(".shop_search input").on("click",function(t){$(".shop_search").addClass("input_active"),a=$.trim($(t.target).val()),a?e._keywordJson(a):e._latelyAndHot()}),$(".search_button").on("click",function(){var e=location.origin,t=$(".shop_search input").val();$.ajax({url:l,dataType:"jsonp",jsonp:"callback",data:{keyword:t},complete:function(){location.origin||(e=""),window.location.href=e+"/search.action?"+"keyword="+encodeURIComponent(t)}})}),$(".shop_search input").on("keyup",function(t){var n;t.keyCode!=38&&t.keyCode!=40&&t.keyCode!=13&&t.keyCode!=108?(a=$.trim($(t.target).val()),a?e._keywordJson(a):e._latelyAndHot()):(n=$(".shop_sl").find(".searchStr").parent("li"),t.keyCode==38?e._up(n):t.keyCode==40?e._down(n):(t.keyCode==13||t.keyCode==108)&&e._enter())}),$(".shop_search").mouseleave(function(){$(".shop_recommend").html("")}),$(document).on("click",function(e){var t=$(e.target);!t.closest(".shop_search").length&&!t.closest(".clearThis").length&&!t.closest(".clearAll").length&&$(".shop_search").removeClass("input_active")}),$(".shop_recommend").on("click","li.artistRemind",function(e){var t=location.origin;location.origin||(t=""),window.location.href=t+"/artist.action?"+"keyword="+encodeURIComponent(a)+"&artistId="+$(e.currentTarget).attr("data-id")})},_showLoginBox:function(t){t.preventDefault(),e(["loginBox"],function(e){e.status()=="hide"?e.trigger("show"):e.trigger("hide")})},_loginHandler:function(){$(".user_hover p").text(g(r.get("userName"),10)).attr("title",r.get("userName")),r.getUserInfo("headImg",function(e){$(".userInfo img").attr("src",e).show()}),$(".userInfo").show(),$.ajax({url:"//shop.yinyuetai.com/shop-cart-count",dataType:"jsonp",jsonp:"callback",success:function(e){e.error?$("#cartNum").css("display","none"):($("#cartNum").html(e.cartCount),$("#cartNum").css("display","inline-block"))}})},_notLoginHandler:function(){var e,t;t=this,e=0,$(window).on("focus",function(){r.emit()})},_down:function(e){var t=$(e),n=-1;for(var r=0;r<t.length-1;r++)t.eq(r).hasClass("chose")&&(n=r);n>-1&&n<t.length?(n++,$(t).removeClass("chose"),t.eq(n).addClass("chose")):($(t).removeClass("chose"),t.eq(0).addClass("chose"))},_up:function(e){var t=$(e),n=-1;for(var r=0;r<t.length;r++)t.eq(r).hasClass("chose")&&(n=r);n>-1&&n<t.length?(n--,$(t).removeClass("chose"),t.eq(n).addClass("chose")):($(t).removeClass("chose"),t.eq(t.length-1).addClass("chose"))},_enter:function(){$("li.chose .searchStr").html()&&$(".shop_search input").val($("li.chose .searchStr").html()),$(".search_button").click()},_keywordJson:function(e){function i(){$.ajax({url:f,dataType:"jsonp",jsonp:"callback",data:{keyword:e,size:6},timeout:1500,success:function(e){e.status=="200"&&e.data.length!=0&&(t=o(s.tplKeyword,e)),u(t)},error:function(){u(t)}})}function u(t){$.ajax({url:c,dataType:"jsonp",jsonp:"callback",data:{keyword:e,size:2},timeout:1500,success:function(r){r.status=="200"&&(r.data.length!=0&&(n=o(s.tplArtist,r)),d.html(t+n),$(".pointkey").html("‘"+e+"’"),$(".shop_recommend ul:last-child").css({"margin-bottom":"11px"}),v._searchClick())},error:function(){d.html(t),$(".shop_recommend ul:last-child").css({"margin-bottom":"11px"}),v._searchClick()}})}var t="",n="",r=this;i()},_latelyAndHot:function(){var e="",t="",n=3,r="",i=this,u=["<li>",'<a href="{{link}}" class="recentsrch searchStr" target="_blank">{{name}}</a>',"</li>"].join("");$.ajax({url:h,dataType:"jsonp",jsonp:"callback",data:{latsize:6,hotsize:6},timeout:1500,success:function(i){i.data.LATEST.length!=0&&(e=o(s.tplLatest,i));if(i.data.HOT.length!=0){i.data.LATEST.length<5&&(n=8-i.data.LATEST.length);var a=n<i.data.HOT.length?n:i.data.HOT.length;for(var f=0;f<a;f++)r+=o(u,i.data.HOT[f]);t=['<ul class="shop_sl shop_sl_hot">',"<p>热门搜索</p>",r,"</ul>"].join(""),console.log(t)}d.html(e+t),$(".shop_recommend ul:last-child").css({"margin-bottom":"11px"}),m._clearLi(),v._searchClick()},error:function(){d.html("")}})},_searchClick:function(){$(".shop_sl_latest").on("click","li",function(e){$(e.target).html()!="删除"&&($(".shop_search input").val($(e.currentTarget).children(".searchStr").html()),$(".search_button").click())}),$(".shop_sl_key").on("click","li",function(e){$(e.target).html()!="删除"&&($(".shop_search input").val($(e.currentTarget).children(".searchStr").html()),$(".search_button").click())})}},m={_clearLi:function(){$(".shop_sl_latest").on("click",".clearThis",function(e){var t=$(e.target).prev().html();$(e.target).parent().remove(),m._remove(0,t)}),$(".shop_sl_latest").on("click",".clearAll",function(){$(".clearAll").parent().parent().remove(),m._remove(1)})},_remove:function(e,t){$.ajax({url:p,dataType:"jsonp",jsonp:"callback",data:{type:e,keyword:t},success:function(){v._latelyAndHot()}})}};n.exports={init:y}});