define(["require","cookie","modules/util/history","user","prober","placeholder","modules/widget/autocomplete","juicer"],function(e){function l(e,t,n){var r,i,s,o,u,a;r=0,i="",s=/[^\x00-\xff]/g,o="",u=e.replace(s,"**").length;for(a=0;a<u;a++){o=e.charAt(a).toString(),o.match(s)!=null?r+=2:r++;if(r>t)break;i+=o}return n&&u>t&&(i+="..."),i}function c(){var e=this.$el;h().css({width:"100%",height:"50px"}).insertAfter(e);var t=h().css({top:"50px",display:"none"}).appendTo(e.find(".content"));e.find(".hoverhandler").hover(function(){var e=$(this).find(".dropdownmenu");t.css({display:"block",width:e.length>0&&e.data("width")||$(this).find("li").eq(0).width(),height:e.length>0&&e.data("height")||$(this).find("li").length*33-4,left:e.length>0&&e.offset().left||$(this).offset().left})},function(){t.css({display:"none"})})}function h(){return $("<iframe />").attr({frameborder:0,scrolling:"no","class":"iframeshim"})}var t,n,r,i,s,o,u,a,f;n=e("cookie"),f=e("modules/util/history"),History=new f("yyt_search_history"),r=e("user"),i=e("prober"),o=e("placeholder"),s=e("modules/widget/autocomplete"),u=e("juicer"),a="https://uapi.yinyuetai.com/online/notify",t=Backbone.View.extend({initialize:function(){var t=this;this.normalListData={},e(["modules/yinyuetai/login-register/main"]),this._uploadBtnHandler(),r.isLogined()||this._notLoginHandler(),r.logined(function(){$(window).off("focus"),t._loginHandler(),t._subscription()}),this._menusHoverEffect(),this._searchInputFocusEffect(),this._resize(),$(window).resize(function(){t._resize()}),this._getSearchData(),this._clearSearchHistory(),new s(t.$el.find("[name=keyword]"),{source:"http://so.yinyuetai.com/search/smart-search",container:t.$el.find(".autocomplete"),template:$("#autocompleteTpl").html()}),(location.href.indexOf("so.yinyuetai.com")!=-1||location.href.indexOf("i.yinyuetai.com/s")!=-1)&&t.$el.find("[name=keyword]").parents("form").attr("target",""),c.call(t)},_subscription:function(){var e=this;$.getJSON(a+"?callback=?",function(e){if(e.code&&e.code==1&&!e.error){var t=e.result.nofity,n=e.result.nofity[10]+e.result.nofity[12];e.result.nofity[10]>0&&e.result.nofity[12]>0?($(".subBtn").attr("href","http://u.yinyuetai.com/subscriber.html"),$(".subBtn span").text(parseInt(n)>99?"99+":n).show()):e.result.nofity[10]>0?($(".subBtn").attr("href","http://u.yinyuetai.com/subscriber.html"),$(".subBtn span").text(parseInt(e.result.nofity[10])>99?"99+":n).show()):e.result.nofity[12]>0&&($(".subBtn").attr("href","http://u.yinyuetai.com/subscriber-follow.html"),$(".subBtn span").text(parseInt(e.result.nofity[12])>99?"99+":n).show())}})},_getSearchData:function(){var e=this;$.ajax({url:"http://soapi.yinyuetai.com/search/rec",data:{type:"index"},dataType:"jsonp",cache:!0,success:function(t){var n={},r=History.getList(),i=[],s=t.result;e.normalListData.result=t.result;if(r!==null){n.historyList=r;for(var o=0;o<r.length+1;o++)s=s.slice(0,-1)}n.result=s,$("#autocompletenormalTpl").html(u.to_html($("#autocompletenormalTpl").html(),n)),t.keyword!=""&&t.keyword!=null?$(".searchbody input").attr({value:t.keyword,"data-url":t.placeholder.searchUrl}):$(".searchbody input").attr({placeholder:t.placeholder.word,"data-url":t.placeholder.searchUrl})}})},_clickLogStatis:function(){var e=this;$("body").on("click",".logStatisEle",function(){var t=$(this).data("word"),n=$(this).data("id");e._logStatis(t,n)})},_clearSearchHistory:function(){var e=this;$("body").on("click",".clear-history-btn",function(){History.clearHistory(),$("#autocompletenormalTpl").html(u.to_html($("#autocompletenormalTplClearHistory").html(),e.normalListData))})},_logStatis:function(e,t){var n=t?t:null,r,i=$("input[name='keyword']");e?r=e:i.val()?r=i.val():r=i.attr("placeholder"),$.ajax({url:"http://log.collect.yinyuetai.com/us-stat",data:{sid:null,pt:1,ot:null,cid:null,c:r,cn:null,f:null,hasCollection:null,sc:null,url:location.href,videoid:n,l:null},dataType:"jsonp",cache:!0,success:function(){}})},_uploadBtnHandler:function(){$("body").on("click",".topbar .uploadBtn",function(e){r.login(function(){window.location.href="http://i.yinyuetai.com/upload"}),e.preventDefault()})},_menusHoverEffect:function(){var e;i.browser.name=="ie"&&i.browser.version==6&&(e=this.$el.find(".hoverhandler"),e.mouseenter(function(){$(this).addClass("hover")}),e.mouseleave(function(){$(this).removeClass("hover")}))},_searchInputFocusEffect:function(){var e=this.$el.find(".search");e.find("input").focus(function(){e.addClass("focus")}),e.find("input").blur(function(){e.removeClass("focus")})},_resize:function(){var e,t;e=this,t=_.throttle(function(){e.$el.width()<=1290?(e.$el.find(".menu").css("margin","0"),e.$el.find(".menu").css("margin","-2px"),e.$el.find(".vip").css("margin-right","-6px"),e.$el.find(".upload").css("margin-right","0"),e.$el.find(".search").css("margin-right","10px"),e.$el.find(".appBox").css("margin","0px -14px 0px 6px"),e.$el.find(".menus .link").css("padding","0 7px 0 7px"),e.$el.find(".menu_folk").hide()):e.$el.width()<=1305?(e.$el.find(".menu").css("margin","0 6px"),e.$el.find(".appBox").css("margin","0px -13px 0px -2px"),e.$el.find(".vip").css("margin-right","4px"),e.$el.find(".upload").css("margin-right","5px"),e.$el.find(".search").css("margin-right","4px"),e.$el.find(".menu_folk").show()):(e.$el.find(".menu").css("margin","0 6px"),e.$el.find(".appBox").css("margin","0px -7px 0 6px"),e.$el.find(".vip").css("margin-right","4px"),e.$el.find(".upload").css("margin-right","10px"),e.$el.find(".search").css("margin-right","30px"),e.$el.find(".menu_folk").show())},200),t()},_searchReseize:function(){var e,t;e=this,t=_.throttle(function(){var t,n,i,s,o,u,a,f,l;e.$el.width()<=1270?(e.$el.find(".content").css("padding","0 0 0 2px"),e.$el.find(".menus .border").css("margin","13px 0 0"),e.$el.find(".menus .link").css("padding","0 6px 0 6px")):e.$el.width()<=1420?(e.$el.find(".content").css("padding","0 0 0 4px"),e.$el.find(".menus .border").css("margin","13px 0 0"),e.$el.find(".menus .link").css("padding","0 8px 0 8px")):e.$el.width()<=1530?(e.$el.find(".content").css("padding","0 0 0 16px"),e.$el.find(".menus .border").css("margin","13px 8px 0"),e.$el.find(".menus .link").css("padding","0 10px 0 11px")):(e.$el.find(".content").css("padding","0 20px"),e.$el.find(".menus .border").css("margin","13px 13px 0"),e.$el.find(".menus .link").css("padding","0 12px 0 13px")),t=e.$el.find(".content").width(),n=e.$el.find("h1").width(),s=e.$el.find(".userinfo").width(),o=e.$el.find(".login").width(),a=e.$el.find(".search"),f=a.find(".searchbody"),l=a.find("input"),i=e.$el.find(".menus").width(),r.isLogined()?u=t-(i+n+s):u=t-(i+n+o);var c=215,h=u-100;h>c&&(h=c),a.width(h),f.width(h-30),l.width(h-45);var p=(u-h-50)/2;p<2&&(p=2),a.css("margin-right",p),a.removeClass("hide")},200),t()},_notLoginHandler:function(){var e,t;t=this,e=0,$(window).on("focus",function(){r.emit()})},_loginHandler:function(){var t,i,s;t=this.$el.find(".userinfo"),i=this.$el.find(".decoration"),s=this.$el.find(".login").eq(0);var o=r.get("vipLevel"),u=r.get("rewardImg");t.find(".user span").text(l(r.get("userName"),10)).attr("title",r.get("userName")),t.find(".userBox .name").html(r.get("userName")),t.find(".userBox img").attr("src",decodeURIComponent(n.get("u_inf")).split(String.fromCharCode(2))[4]),i.attr("href",i.attr("href").replace("userId",r.get("userId"))),o>0&&(t.find(".userBox").addClass("userVip"),t.find(".vip i").hide(),t.find(".ico_vip_levels").css("display","inline-block").addClass("ico_vip_levels_"+o).attr("title","VIP"+o+"çº§")),u&&(t.find(".vip i").hide(),t.find(".reward").show().attr("src",u)),s.addClass("hide"),t.removeClass("hide"),$(function(){setTimeout(function(){e(["modules/yinyuetai/messenger2"],function(){})},5e3)})}}),new t({el:$(".topbar")})});