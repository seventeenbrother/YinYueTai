define(["require","exports","module","ajaxform","modules/yinyuetai/login-register/login-tools","modules/yinyuetai/login-register/art-template","modules/yinyuetai/login-register/get-code","pwdencrypt","dialog","user"],function(e,t,n){var r=e("ajaxform"),i=e("modules/yinyuetai/login-register/login-tools"),s=i.API,o=e("modules/yinyuetai/login-register/art-template"),u=e("modules/yinyuetai/login-register/get-code"),a=e("pwdencrypt"),f=e("dialog"),l=e("user"),c=Backbone.View.extend({el:"body",events:{"blur input":"_inputBlur","click .inter-content-bind .area-code-content":"_codeDisplay","click .inter-content-bind .code-list li":"_codeChoise"},observer:new i.Observer,initialize:function(e){var t=this;t.template=o("phone-template"),t._renderDialog(),t._getDOM(),t.show(),$.when(i.iframeAjax({url:s.getSign,data:{type:"bnd"}})).then(function(e){console.log(e),t.sign=e.sign,t._createGetCode(),t._createSignInput(),t._formSubmit(),t._errorTipsHandler(),t._bindPhoneSuccess(),t._manualCloseDialog()})},_renderDialog:function(){this.BindPhoneDialog=new f(this.template,{width:550,height:290,isRemoveAfterHide:!1,isAutoShow:!1,draggable:!1}),this.BindPhoneDialog.$el.find("input").placeholder(),this._documentEvent()},_manualCloseDialog:function(){var e=this;this.BindPhoneDialog.$el.find(".J_close").click(function(){e.hide(),i.observer.pub("manualCloseBindPhoneDialog")})},_inputBlur:function(){this.observer.pub("inputBlur")},show:function(){this.BindPhoneDialog.show(),i.observer.pub("bindPhoneDialogShow")},hide:function(){this.BindPhoneDialog.hide()},_getDOM:function(){this.form=this.BindPhoneDialog.$el.find(".phone-form"),this.mobileInput=this.form.find("input[name=phone]"),this.getCodeBtn=this.form.find(".login-get-code"),this.interCode=this.form.find(".country-name"),this.codeNameObj=this.form.find(".country-name"),this.beforedom=this.form.find(".beforedom")},_codeDisplay:function(e){e.target.stopPropagation,$(".inter-content-bind .code-list").css("display")==="none"&&$(".inter-content-bind .code-list").show()},_codeChoise:function(e){e.stopPropagation();var t="",n="";t=$(e.target).data("code"),n=$(e.target).data("name"),this.codeNameObj.text(n),this.codeNameObj.data("code",t),$(".code-list").hide()},_documentEvent:function(){$("body").on("click",function(e){$(e.target).closest(".area-code-content").length==0&&$(".code-list").hide()})},_createGetCode:function(){this.oGetCode=new u({type:"bnd",beforeDOM:this.beforedom,mobileInput:this.mobileInput,interCode:this.interCode,needAuth:!1,sign:this.sign,bindPhone:!0})},_createSignInput:function(){this.signInput=$("<input />").attr({name:"sign",type:"hidden",value:this.sign}),this.newMobileInput=$("<input />").attr({name:"mobile",type:"hidden",value:""}),this.form.append(this.signInput),this.form.append(this.newMobileInput)},_errorTipsHandler:function(){function t(t){e.errorDiv.html(t)}var e=this;e.errorDiv=e.form.find(".login-error-tips"),e.oGetCode.observer.sub("getCodeError",t),e.observer.sub("bindPhoneError",t),e.observer.sub("inputBlur",function(){t("")})},_interCheck:function(e){var t=e;i.checkEmail(e)||this.interCode.data("code")!=""&&(t=this.interCode.data("code")+"-"+$.trim(this.mobileInput.val())),console.log(t),this.newMobileInput.val(t)},_formSubmit:function(){var e=this;this.submitBtn=this.form.find("input[type=submit]"),this.submitBtn.click(function(t){e.mobileInput.val(e.mobileInput.val().trim());if(e.mobileInput.val().length<=0)return e.errorDiv.html("手机号不能为空"),!1;e.oGetCode.input.val(e.oGetCode.input.val().trim());if(e.oGetCode.input.val().length<=0)return e.errorDiv.html("请输入验证码"),!1;e._interCheck(e.mobileInput.val()),new r(e.form,{onComplete:function(t){t.error===!1?(e.observer.pub("bindPhoneSuccess",t),i.observer.pub("bindPhoneSuccess")):e.observer.pub("bindPhoneError",t.message)}})})},_bindPhoneSuccess:function(){var e=this;this.observer.sub("bindPhoneSuccess",function(){e.hide(),l.emit(),location.href="//www.yinyuetai.com/"})}});return c});